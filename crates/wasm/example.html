<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PDS WASM Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .output {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üåê PDS WASM Demo</h1>
    <p>Browser-based ATProto Personal Data Server</p>

    <div class="section">
        <h2>1. Initialize Repository</h2>
        <input type="text" id="did" placeholder="did:plc:example123" value="did:plc:alice">
        <button onclick="initRepo()">Initialize</button>
        <div class="output" id="init-output"></div>
    </div>

    <div class="section">
        <h2>2. Create Post</h2>
        <textarea id="post-text" placeholder="What's on your mind?">Hello from the browser PDS!</textarea>
        <button onclick="createPost()">Create Post</button>
        <div class="output" id="post-output"></div>
    </div>

    <div class="section">
        <h2>3. Edit Profile</h2>
        <input type="text" id="display-name" placeholder="Display Name" value="Alice">
        <textarea id="bio" placeholder="Bio">I love decentralized protocols!</textarea>
        <button onclick="editProfile()">Update Profile</button>
        <div class="output" id="profile-output"></div>
    </div>

    <div class="section">
        <h2>4. List Records</h2>
        <button onclick="listPosts()">List Posts</button>
        <button onclick="listProfiles()">List Profiles</button>
        <div class="output" id="list-output"></div>
    </div>

    <div class="section">
        <h2>5. Export & Backup</h2>
        <button onclick="exportSnapshot()">Export Snapshot</button>
        <button onclick="createBackup()">Create Backup</button>
        <div class="output" id="export-output"></div>
    </div>

    <div class="section">
        <h2>6. Repository Info</h2>
        <button onclick="getInfo()">Get Info</button>
        <div class="output" id="info-output"></div>
    </div>

    <script type="module">
        import init, { WasmRepository } from './pkg/pds_wasm.js';

        // Global repository instance
        let repo;

        // Initialize WASM
        async function initWasm() {
            await init();
            console.log("WASM initialized");
            window.repo = new WasmRepository();
        }

        // Initialize repository
        window.initRepo = async function() {
            try {
                const did = document.getElementById('did').value;
                const result = await window.repo.init_identity(did);
                document.getElementById('init-output').innerHTML = 
                    `‚úÖ Repository initialized<br>DID: <code>${result}</code>`;
            } catch (err) {
                document.getElementById('init-output').innerHTML = 
                    `‚ùå Error: ${err}`;
            }
        };

        // Create post
        window.createPost = async function() {
            try {
                const text = document.getElementById('post-text').value;
                const cid = await window.repo.create_post(text);
                document.getElementById('post-output').innerHTML = 
                    `‚úÖ Post created<br>CID: <code>${cid}</code>`;
            } catch (err) {
                document.getElementById('post-output').innerHTML = 
                    `‚ùå Error: ${err}`;
            }
        };

        // Edit profile
        window.editProfile = async function() {
            try {
                const displayName = document.getElementById('display-name').value;
                const bio = document.getElementById('bio').value;
                const cid = await window.repo.edit_profile(displayName, bio);
                document.getElementById('profile-output').innerHTML = 
                    `‚úÖ Profile updated<br>CID: <code>${cid}</code>`;
            } catch (err) {
                document.getElementById('profile-output').innerHTML = 
                    `‚ùå Error: ${err}`;
            }
        };

        // List posts
        window.listPosts = async function() {
            try {
                const records = window.repo.list_records("app.bsky.feed.post");
                const parsed = JSON.parse(records);
                document.getElementById('list-output').innerHTML = 
                    `‚úÖ Found ${parsed.length} posts<br><pre>${JSON.stringify(parsed, null, 2)}</pre>`;
            } catch (err) {
                document.getElementById('list-output').innerHTML = 
                    `‚ùå Error: ${err}`;
            }
        };

        // List profiles
        window.listProfiles = async function() {
            try {
                const records = window.repo.list_records("app.bsky.actor.profile");
                const parsed = JSON.parse(records);
                document.getElementById('list-output').innerHTML = 
                    `‚úÖ Found ${parsed.length} profiles<br><pre>${JSON.stringify(parsed, null, 2)}</pre>`;
            } catch (err) {
                document.getElementById('list-output').innerHTML = 
                    `‚ùå Error: ${err}`;
            }
        };

        // Export snapshot
        window.exportSnapshot = async function() {
            try {
                const snapshot = window.repo.export_for_publish();
                const parsed = JSON.parse(snapshot);
                document.getElementById('export-output').innerHTML = 
                    `‚úÖ Snapshot exported<br><pre>${JSON.stringify(parsed, null, 2).substring(0, 500)}...</pre>`;
            } catch (err) {
                document.getElementById('export-output').innerHTML = 
                    `‚ùå Error: ${err}`;
            }
        };

        // Create backup
        window.createBackup = async function() {
            try {
                const backup = window.repo.backup();
                const blob = new Blob([backup], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pds-backup.json';
                a.click();
                document.getElementById('export-output').innerHTML = 
                    `‚úÖ Backup downloaded`;
            } catch (err) {
                document.getElementById('export-output').innerHTML = 
                    `‚ùå Error: ${err}`;
            }
        };

        // Get info
        window.getInfo = async function() {
            try {
                const did = window.repo.get_did();
                const publicKey = window.repo.get_public_key();
                document.getElementById('info-output').innerHTML = 
                    `DID: <code>${did || 'Not initialized'}</code><br>` +
                    `Public Key: <code>${publicKey ? publicKey.substring(0, 40) + '...' : 'Not initialized'}</code>`;
            } catch (err) {
                document.getElementById('info-output').innerHTML = 
                    `‚ùå Error: ${err}`;
            }
        };

        // Auto-initialize on load
        initWasm();
    </script>
</body>
</html>
